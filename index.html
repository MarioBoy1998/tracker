<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Table Tracker</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  min-height: 100vh;
}
.header {
  background: rgba(0,0,0,0.2);
  backdrop-filter: blur(10px);
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.header h1 { font-size: 24px; }
.status {
  padding: 8px 20px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
}
.status.active { background: #22c55e; color: #000; }
.status.inactive { background: #ef4444; color: #fff; }
.rooms {
  padding: 20px;
  display: grid;
  gap: 20px;
}
.room {
  background: rgba(255,255,255,0.95);
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}
.room-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
  color: #fff;
  font-size: 20px;
  font-weight: 700;
}
.room-body {
  padding: 30px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 20px;
}
.table {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.3s;
}
.table:hover { transform: scale(1.1); }
.table.active {
  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
  box-shadow: 0 4px 15px rgba(34,197,94,0.3);
}
.table.warning {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  box-shadow: 0 4px 15px rgba(245,158,11,0.3);
}
.table-id { font-size: 28px; }
.table-rssi { font-size: 11px; opacity: 0.9; margin-top: 4px; }
.info {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(0,0,0,0.7);
  color: #fff;
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 11px;
}
</style>
</head>
<body>

<div class="header">
  <h1>üéØ Table Tracker</h1>
  <div class="status active" id="status">Polling...</div>
</div>

<div class="rooms" id="rooms">
  <div style="text-align: center; padding: 100px 20px; font-size: 18px;">
    Waiting for data...
  </div>
</div>

<div class="info" id="info">
  Updates: 0<br>
  Mode: HTTP Polling
</div>

<script>
// ===== CONFIG =====
const BROKER_API = 'https://api.broker.emqx.io';  // REST API endpoint
const POLL_INTERVAL = 3000;  // –û–ø–∏—Ç—É–≤–∞—Ç–∏ –∫–æ–∂–Ω—ñ 3 —Å–µ–∫—É–Ω–¥–∏

let updateCount = 0;
let masters = {};
let lastData = {};

// ===== Polling Function =====
async function pollMQTT() {
  try {
    // –¶–µ –ø—Ä–∏–∫–ª–∞–¥ - —Ç—Ä–µ–±–∞ –∑–Ω–∞–π—Ç–∏ REST API –¥–ª—è —Ç–≤–æ–≥–æ –±—Ä–æ–∫–µ—Ä–∞
    // –ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –≤–ª–∞—Å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä —è–∫ –ø—Ä–æ–∫—Å—ñ
    
    // –¢–ò–ú–ß–ê–°–û–í–ï –†–Ü–®–ï–ù–ù–Ø: –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ localStorage –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ—ó —Å–∏–º—É–ª—è—Ü—ñ—ó
    const stored = localStorage.getItem('tracker_data');
    if (stored) {
      const data = JSON.parse(stored);
      handleData(data);
    }
    
    document.getElementById('status').className = 'status active';
    document.getElementById('status').textContent = 'Active';
    
  } catch (e) {
    console.error('Poll error:', e);
    document.getElementById('status').className = 'status inactive';
    document.getElementById('status').textContent = 'Error';
  }
  
  updateCount++;
  document.getElementById('info').innerHTML = 
    `Updates: ${updateCount}<br>Mode: HTTP Polling<br>Objects: ${Object.keys(masters).length}`;
}

function handleData(data) {
  const now = Date.now();
  
  const masterId = data.master_id || 'master1';
  
  masters[masterId] = {
    room: data.room,
    lastSeen: now,
    tables: data.tables || []
  };
  
  renderRooms();
}

function renderRooms() {
  const now = Date.now();
  let html = '';
  let rooms = {};
  
  for (let masterId in masters) {
    const master = masters[masterId];
    
    if (now - master.lastSeen > 60000) continue;
    
    const roomName = master.room;
    if (!rooms[roomName]) rooms[roomName] = [];
    
    master.tables.forEach(table => {
      rooms[roomName].push(table);
    });
  }
  
  if (Object.keys(rooms).length === 0) {
    html = '<div style="text-align: center; padding: 100px 20px;">No data</div>';
  } else {
    for (let roomName in rooms) {
      const roomTables = rooms[roomName];
      
      html += `
      <div class="room">
        <div class="room-header">${roomName}</div>
        <div class="room-body">`;
      
      roomTables.forEach(table => {
        const status = table.last_seen < 30000 ? 'active' : 'warning';
        
        html += `
        <div class="table ${status}">
          <div class="table-id">${table.id}</div>
          <div class="table-rssi">${table.rssi} dBm</div>
        </div>`;
      });
      
      html += '</div></div>';
    }
  }
  
  document.getElementById('rooms').innerHTML = html;
}

// Start polling
setInterval(pollMQTT, POLL_INTERVAL);
pollMQTT();

// –î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è: —Å–∏–º—É–ª—é–≤–∞—Ç–∏ –¥–∞–Ω—ñ
console.log('üí° –î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è, –≤ –∫–æ–Ω—Å–æ–ª—ñ –≤–∏–∫–æ–Ω–∞–π:');
console.log('localStorage.setItem("tracker_data", JSON.stringify({room:"Room 1", master_id:"master1", tables:[{id:2, rssi:-58, last_seen:0}]}))');
</script>

</body>
</html>
