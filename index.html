<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Table Tracker</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #000000;
  color: #ffffff;
  min-height: 100vh;
}

.header {
  background: #0a0a0a;
  border-bottom: 1px solid #1a1a1a;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}

.header h1 {
  font-size: 16px;
  font-weight: 600;
  color: #dc2626;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.status {
  padding: 5px 12px;
  border-radius: 3px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.status.online {
  background: #15803d;
  color: #fff;
}

.status.offline {
  background: #7f1d1d;
  color: #fff;
}

.stats-bar {
  background: #0a0a0a;
  border-bottom: 1px solid #1a1a1a;
  padding: 12px 20px;
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  overflow-x: auto;
}

.stat {
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 60px;
}

.stat-label {
  font-size: 9px;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.stat-value {
  font-size: 20px;
  font-weight: 700;
  color: #fff;
}

.stat-value.red {
  color: #dc2626;
}

.content {
  padding: 15px;
  max-width: 1600px;
  margin: 0 auto;
}

.room-section {
  background: #0a0a0a;
  border: 1px solid #1a1a1a;
  border-radius: 4px;
  margin-bottom: 15px;
  overflow: hidden;
}

.room-section.offline {
  border-color: #7f1d1d;
  opacity: 0.7;
}

.room-header {
  background: #0d0d0d;
  border-bottom: 1px solid #1a1a1a;
  padding: 12px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}

.room-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.room-title {
  font-size: 13px;
  font-weight: 600;
  color: #fff;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.master-status {
  font-size: 10px;
  padding: 3px 8px;
  border-radius: 2px;
  font-weight: 600;
  white-space: nowrap;
}

.master-status.online {
  background: #15803d;
  color: #fff;
}

.master-status.offline {
  background: #7f1d1d;
  color: #fff;
}

.room-info {
  display: flex;
  gap: 15px;
  font-size: 10px;
  color: #666;
  flex-wrap: wrap;
}

.room-info-item {
  display: flex;
  gap: 5px;
  white-space: nowrap;
}

.room-info-label {
  color: #444;
}

.room-info-value {
  color: #888;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞ —Å—ñ—Ç–∫–∞ –¥–ª—è —Å—Ç–æ–ª–∏–∫—ñ–≤ */
.table-grid {
  padding: 15px;
  display: grid;
  gap: 10px;
  
  /* –ú–æ–±—ñ–ª–∫–∞: 3 —Å—Ç–æ–ª–∏–∫–∞ */
  grid-template-columns: repeat(3, 1fr);
}

/* –ü–ª–∞–Ω—à–µ—Ç: 6 —Å—Ç–æ–ª–∏–∫—ñ–≤ */
@media (min-width: 600px) {
  .table-grid {
    grid-template-columns: repeat(6, 1fr);
    gap: 12px;
  }
}

/* –î–µ—Å–∫—Ç–æ–ø –º–∞–ª–∏–π: 8 —Å—Ç–æ–ª–∏–∫—ñ–≤ */
@media (min-width: 900px) {
  .table-grid {
    grid-template-columns: repeat(8, 1fr);
    gap: 15px;
  }
}

/* –î–µ—Å–∫—Ç–æ–ø –≤–µ–ª–∏–∫–∏–π: 12 —Å—Ç–æ–ª–∏–∫—ñ–≤ */
@media (min-width: 1400px) {
  .table-grid {
    grid-template-columns: repeat(12, 1fr);
  }
}

.empty-room {
  padding: 30px 15px;
  text-align: center;
  color: #444;
  font-size: 11px;
}

.table-item {
  background: #0d0d0d;
  border: 2px solid #1a1a1a;
  border-radius: 4px;
  padding: 10px 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.table-item:hover {
  border-color: #333;
  transform: translateY(-2px);
}

.table-item.active {
  border-color: #15803d;
  background: #0f1f13;
}

.table-item.warning {
  border-color: #b45309;
  background: #1a1107;
}

.table-item.inactive {
  border-color: #991b1b;
  background: #1a0808;
}

.table-item.moving {
  border-color: #9333ea;
  background: #1e1034;
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.table-id {
  font-size: 20px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 4px;
}

.table-rssi {
  font-size: 10px;
  color: #666;
  font-weight: 600;
}

.table-status {
  font-size: 8px;
  color: #444;
  margin-top: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.table-confidence {
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 8px;
  color: #666;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #333;
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.3;
}

.empty-text {
  font-size: 14px;
  color: #666;
}

.footer-info {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: #0a0a0a;
  border: 1px solid #1a1a1a;
  border-radius: 4px;
  padding: 8px 12px;
  font-size: 9px;
  color: #666;
  font-family: 'Courier New', monospace;
  z-index: 1000;
}

.footer-info .label {
  color: #444;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.footer-info .value {
  color: #dc2626;
  font-weight: 600;
}

.loading {
  text-align: center;
  padding: 100px 20px;
  color: #333;
}

.spinner {
  border: 3px solid #1a1a1a;
  border-top: 3px solid #dc2626;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Mobile optimizations */
@media (max-width: 600px) {
  .header {
    padding: 12px 15px;
  }
  
  .header h1 {
    font-size: 14px;
  }
  
  .stats-bar {
    padding: 10px 15px;
    gap: 15px;
  }
  
  .stat-value {
    font-size: 18px;
  }
  
  .content {
    padding: 10px;
  }
  
  .room-header {
    padding: 10px 12px;
  }
  
  .table-grid {
    padding: 10px;
    gap: 8px;
  }
  
  .table-id {
    font-size: 18px;
  }
  
  .footer-info {
    font-size: 8px;
    padding: 6px 10px;
  }
}
</style>
</head>
<body>

<div class="header">
  <h1>‚ö° Table Tracker</h1>
  <div class="status offline" id="status">OFFLINE</div>
</div>

<div class="stats-bar">
  <div class="stat">
    <div class="stat-label">Rooms</div>
    <div class="stat-value" id="stat-rooms">0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Tables</div>
    <div class="stat-value" id="stat-tables">0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Active</div>
    <div class="stat-value red" id="stat-active">0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Masters</div>
    <div class="stat-value" id="stat-masters">0</div>
  </div>
</div>

<div class="content" id="content">
  <div class="loading">
    <div class="spinner"></div>
    <div style="font-size: 14px; color: #666;">CONNECTING TO FIREBASE</div>
  </div>
</div>

<div class="footer-info" id="footer">
  <div><span class="label">Backend:</span> <span class="value">Firebase</span></div>
  <div><span class="label">Updates:</span> <span class="value" id="update-count">0</span></div>
  <div><span class="label">Last:</span> <span class="value" id="last-update">--:--:--</span></div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCWNko1tniaerF3b9Wi8HDS0muhymvIVoQ",
  authDomain: "table-tracker-712c8.firebaseapp.com",
  databaseURL: "https://table-tracker-712c8-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "table-tracker-712c8",
  storageBucket: "table-tracker-712c8.firebasestorage.app",
  messagingSenderId: "868274806628",
  appId: "1:868274806628:web:36b9ec7ae969ab3ec2e471"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

console.log('üî• Firebase initialized');

/* ================= CONFIG ================= */
const RSSI_HYSTERESIS = 8;           // 8 dBm —Ä—ñ–∑–Ω–∏—Ü—è –¥–ª—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è
const TIME_THRESHOLD = 15000;         // 15 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è–º
const MASTER_SYNC_WINDOW = 10000;     // 10 —Å–µ–∫—É–Ω–¥ - –≤—ñ–∫–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó Masters
const MASTER_TIMEOUT = 60000;         // 60 —Å–µ–∫—É–Ω–¥ - Master offline
const CONFIDENCE_THRESHOLD = 0.7;     // 70% –≤–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ –¥–ª—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è

let updateCount = 0;
let tableLocations = {};              // –ü–æ—Ç–æ—á–Ω–µ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è —Å—Ç–æ–ª–∏–∫—ñ–≤
let masterUpdateTimes = {};           // –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω–æ–≥–æ Master
let tableHistory = {};                // –Ü—Å—Ç–æ—Ä—ñ—è —Å–∏–≥–Ω–∞–ª—ñ–≤ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å—Ç–æ–ª–∏–∫–∞

/* ================= –ë–£–§–ï–†–ò–ó–ê–¶–Ü–Ø –î–ê–ù–ò–• ================= */
// –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é –æ—Å—Ç–∞–Ω–Ω—ñ—Ö 3 –æ–Ω–æ–≤–ª–µ–Ω—å –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å—Ç–æ–ª–∏–∫–∞
function updateTableHistory(tableId, roomName, rssi, timestamp) {
  if (!tableHistory[tableId]) {
    tableHistory[tableId] = [];
  }
  
  tableHistory[tableId].push({
    room: roomName,
    rssi: rssi,
    timestamp: timestamp
  });
  
  // –¢—Ä–∏–º–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –æ—Å—Ç–∞–Ω–Ω—ñ 3 –∑–∞–ø–∏—Å–∏
  if (tableHistory[tableId].length > 3) {
    tableHistory[tableId].shift();
  }
}

// –û—Ç—Ä–∏–º–∞—Ç–∏ —É—Å–µ—Ä–µ–¥–Ω–µ–Ω–∏–π RSSI –¥–ª—è —Å—Ç–æ–ª–∏–∫–∞ –≤ –∫—ñ–º–Ω–∞—Ç—ñ
function getAverageRSSI(tableId, roomName) {
  if (!tableHistory[tableId]) return null;
  
  const roomReadings = tableHistory[tableId].filter(h => h.room === roomName);
  if (roomReadings.length === 0) return null;
  
  const sum = roomReadings.reduce((acc, r) => acc + r.rssi, 0);
  return sum / roomReadings.length;
}

// –û–±—á–∏—Å–ª–∏—Ç–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å —É —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—ñ —Å—Ç–æ–ª–∏–∫–∞
function calculateConfidence(tableId, roomName, allSightings) {
  if (!tableHistory[tableId] || tableHistory[tableId].length < 2) {
    return 0.5; // –ù–∏–∑—å–∫–∞ –≤–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å –¥–ª—è –Ω–æ–≤–∏—Ö —Å—Ç–æ–ª–∏–∫—ñ–≤
  }
  
  const recentHistory = tableHistory[tableId].slice(-3);
  const roomCount = recentHistory.filter(h => h.room === roomName).length;
  
  // –í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å = —Å–∫—ñ–ª—å–∫–∏ —Ä–∞–∑—ñ–≤ —Å—Ç–æ–ª–∏–∫ –±–∞—á–∏–ª–∏ –≤ —Ü—ñ–π –∫—ñ–º–Ω–∞—Ç—ñ / –∑–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
  return roomCount / recentHistory.length;
}

/* ================= –ü–ï–†–ï–í–Ü–†–ö–ê –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–á MASTERS ================= */
function areMastersSynced(rooms) {
  const now = Date.now();
  const activeMasters = Object.keys(rooms).filter(roomName => {
    const lastUpdate = (rooms[roomName].updated || 0) * 1000;
    return (now - lastUpdate) < MASTER_TIMEOUT;
  });
  
  if (activeMasters.length === 0) return true; // –ù–µ–º–∞—î Masters - –Ω–µ–º–∞ –ø—Ä–æ–±–ª–µ–º–∏
  if (activeMasters.length === 1) return true; // –û–¥–∏–Ω Master - –∑–∞–≤–∂–¥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏–π
  
  // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –≤—Å—ñ –∞–∫—Ç–∏–≤–Ω—ñ Masters –æ–Ω–æ–≤–∏–ª–∏—Å—å –Ω–µ–¥–∞–≤–Ω–æ
  const updateTimes = activeMasters.map(roomName => {
    return (rooms[roomName].updated || 0) * 1000;
  });
  
  const maxTime = Math.max(...updateTimes);
  const minTime = Math.min(...updateTimes);
  
  // –Ø–∫—â–æ —Ä—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º–∏ > MASTER_SYNC_WINDOW - Masters –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ
  return (maxTime - minTime) < MASTER_SYNC_WINDOW;
}

/* ================= –†–û–ó–£–ú–ù–ï –í–ò–ó–ù–ê–ß–ï–ù–ù–Ø –ö–Ü–ú–ù–ê–¢–ò ================= */
function assignTablesToRooms(rooms) {
  const now = Date.now();
  const allTables = {};
  
  // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ —Å–∏–≥–Ω–∞–ª–∏ –≤—ñ–¥ —É—Å—ñ—Ö —Å—Ç–æ–ª–∏–∫—ñ–≤
  for (let roomName in rooms) {
    const room = rooms[roomName];
    const lastUpdate = (room.updated || 0) * 1000;
    const age = now - lastUpdate;
    
    if (age > MASTER_TIMEOUT) continue;
    
    // –û–Ω–æ–≤–∏—Ç–∏ —á–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è Master
    masterUpdateTimes[roomName] = lastUpdate;
    
    const tables = room.tables || [];
    tables.forEach(table => {
      if (!allTables[table.id]) {
        allTables[table.id] = [];
      }
      
      allTables[table.id].push({
        room: roomName,
        rssi: table.rssi,
        last_seen: table.last_seen,
        updated: lastUpdate
      });
      
      // –î–æ–¥–∞—Ç–∏ –¥–æ —ñ—Å—Ç–æ—Ä—ñ—ó
      updateTableHistory(table.id, roomName, table.rssi, lastUpdate);
    });
  }
  
  // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ Masters —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ
  const mastersSync = areMastersSynced(rooms);
  
  const roomAssignments = {};
  
  for (let tableId in allTables) {
    const sightings = allTables[tableId];
    
    // –ó–Ω–∞–π—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É –∑ –Ω–∞–π—Å–∏–ª—å–Ω—ñ—à–∏–º —Å–∏–≥–Ω–∞–ª–æ–º
    let bestSighting = sightings.reduce((best, current) => {
      return current.rssi > best.rssi ? current : best;
    });
    
    // –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—î —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è
    const prevLocation = tableLocations[tableId];
    
    if (prevLocation && prevLocation.confirmed) {
      // –°—Ç–æ–ª–∏–∫ –≤–∂–µ –±—É–≤ –ø—Ä–∏—Å–≤–æ—î–Ω–∏–π
      
      // –ó–Ω–∞–π—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Å–∏–≥–Ω–∞–ª —É –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫—ñ–º–Ω–∞—Ç—ñ
      const currentInPrevRoom = sightings.find(s => s.room === prevLocation.room);
      
      if (currentInPrevRoom) {
        // –°—Ç–æ–ª–∏–∫ –≤—Å–µ —â–µ –≤–∏–¥–Ω–æ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫—ñ–º–Ω–∞—Ç—ñ
        
        const rssiDiff = bestSighting.rssi - currentInPrevRoom.rssi;
        
        // –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —É—Å–µ—Ä–µ–¥–Ω–µ–Ω–∏–π RSSI —è–∫—â–æ —î —ñ—Å—Ç–æ—Ä—ñ—è
        const avgBest = getAverageRSSI(tableId, bestSighting.room);
        const avgPrev = getAverageRSSI(tableId, prevLocation.room);
        
        const effectiveRssiDiff = avgBest && avgPrev 
          ? avgBest - avgPrev 
          : rssiDiff;
        
        if (effectiveRssiDiff > RSSI_HYSTERESIS) {
          // –ù–æ–≤–∏–π —Å–∏–≥–Ω–∞–ª –∑–Ω–∞—á–Ω–æ —Å–∏–ª—å–Ω—ñ—à–∏–π
          
          const timeSinceChange = now - prevLocation.timestamp;
          const confidence = calculateConfidence(tableId, bestSighting.room, sightings);
          
          // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —É–º–æ–≤–∏ –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è:
          // 1. –î–æ—Å—Ç–∞—Ç–Ω—å–æ —á–∞—Å—É –ø—Ä–æ–π—à–ª–æ
          // 2. –í–∏—Å–æ–∫–∞ –≤–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å
          // 3. Masters —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ (–∞–±–æ –Ω–µ–º–∞—î —ñ–Ω—à–∏—Ö Masters)
          if (timeSinceChange > TIME_THRESHOLD && 
              confidence >= CONFIDENCE_THRESHOLD &&
              mastersSync) {
            
            console.log(`üìç Table ${tableId}: ${prevLocation.room} ‚Üí ${bestSighting.room} (${effectiveRssiDiff.toFixed(1)}dB, conf: ${(confidence*100).toFixed(0)}%)`);
            
            tableLocations[tableId] = {
              room: bestSighting.room,
              rssi: bestSighting.rssi,
              timestamp: now,
              confirmed: true,
              confidence: confidence,
              moving: false
            };
          } else {
            // –£–º–æ–≤–∏ –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω—ñ - –∑–∞–ª–∏—à–∞—î–º–æ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫—ñ–º–Ω–∞—Ç—ñ
            // –ê–ª–µ –ø–æ–∑–Ω–∞—á–∞—î–º–æ —è–∫ "moving" —è–∫—â–æ –ø–æ—á–∞–ª–æ—Å—å –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è
            if (timeSinceChange > 0 && effectiveRssiDiff > RSSI_HYSTERESIS) {
              tableLocations[tableId].moving = true;
            }
            
            bestSighting = currentInPrevRoom;
          }
        } else {
          // –°–∏–≥–Ω–∞–ª –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Å–∏–ª—å–Ω—ñ—à–∏–π - –∑–∞–ª–∏—à–∞—î–º–æ
          bestSighting = currentInPrevRoom;
          tableLocations[tableId].timestamp = now;
          tableLocations[tableId].moving = false;
        }
      } else {
        // –°—Ç–æ–ª–∏–∫ –±—ñ–ª—å—à–µ –Ω–µ –≤–∏–¥–Ω–æ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫—ñ–º–Ω–∞—Ç—ñ
        // –ú–∏—Ç—Ç—î–≤–æ –ø–µ—Ä–µ–º—ñ—â—É—î–º–æ (–±–æ –Ω–µ–º–∞—î –≤–∏–±–æ—Ä—É)
        
        console.log(`üìç Table ${tableId}: ${prevLocation.room} ‚Üí ${bestSighting.room} (not visible in prev)`);
        
        tableLocations[tableId] = {
          room: bestSighting.room,
          rssi: bestSighting.rssi,
          timestamp: now,
          confirmed: true,
          confidence: 1.0,
          moving: false
        };
      }
    } else {
      // –ù–æ–≤–∏–π —Å—Ç–æ–ª–∏–∫ - –ø—Ä–∏—Å–≤–æ—é—î–º–æ –¥–æ –Ω–∞–π—Å–∏–ª—å–Ω—ñ—à–æ–≥–æ —Å–∏–≥–Ω–∞–ª—É
      // –ê–ª–µ –∑ –Ω–∏–∑—å–∫–æ—é –≤–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—é —Å–ø–æ—á–∞—Ç–∫—É
      
      const confidence = calculateConfidence(tableId, bestSighting.room, sightings);
      
      tableLocations[tableId] = {
        room: bestSighting.room,
        rssi: bestSighting.rssi,
        timestamp: now,
        confirmed: confidence >= CONFIDENCE_THRESHOLD,
        confidence: confidence,
        moving: false
      };
      
      console.log(`üìç New table ${tableId} in ${bestSighting.room} (conf: ${(confidence*100).toFixed(0)}%)`);
    }
    
    // –î–æ–¥–∞—Ç–∏ —Å—Ç–æ–ª–∏–∫ –¥–æ –ø—Ä–∏—Å–≤–æ—î–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏
    const assignedRoom = tableLocations[tableId].room;
    const tableData = sightings.find(s => s.room === assignedRoom);
    
    if (!roomAssignments[assignedRoom]) {
      roomAssignments[assignedRoom] = [];
    }
    
    roomAssignments[assignedRoom].push({
      id: tableId,
      rssi: tableData.rssi,
      last_seen: tableData.last_seen,
      confidence: tableLocations[tableId].confidence,
      moving: tableLocations[tableId].moving || false
    });
  }
  
  return roomAssignments;
}

/* ================= FIREBASE LISTENER ================= */
const roomsRef = ref(database, 'rooms');

onValue(roomsRef, (snapshot) => {
  updateCount++;
  
  document.getElementById('status').className = 'status online';
  document.getElementById('status').textContent = 'ONLINE';
  document.getElementById('update-count').textContent = updateCount;
  document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
  
  const data = snapshot.val();
  console.log('üì® Firebase update:', data);
  
  if (data) {
    render(data);
  } else {
    showEmpty();
  }
}, (error) => {
  console.error('‚ùå Firebase error:', error);
  document.getElementById('status').className = 'status offline';
  document.getElementById('status').textContent = 'ERROR';
});

/* ================= RENDER ================= */
function render(rooms) {
  const now = Date.now();
  
  // –ü—Ä–∏—Å–≤–æ—ó—Ç–∏ —Å—Ç–æ–ª–∏–∫–∏ –¥–æ –∫—ñ–º–Ω–∞—Ç
  const roomAssignments = assignTablesToRooms(rooms);
  
  let totalRooms = 0;
  let totalTables = 0;
  let activeTables = 0;
  let activeMasters = 0;
  
  let html = '';
  
  // –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –í–°–Ü –∫—ñ–º–Ω–∞—Ç–∏
  for (let roomName in rooms) {
    const roomData = rooms[roomName];
    const tables = roomAssignments[roomName] || [];
    
    totalRooms++;
    totalTables += tables.length;
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ Master online
    const lastUpdate = (roomData.updated || 0) * 1000;
    const masterAge = now - lastUpdate;
    const masterOnline = masterAge < MASTER_TIMEOUT;
    
    if (masterOnline) {
      activeMasters++;
    }
    
    // Count active tables
    tables.forEach(table => {
      if (table.last_seen < 30000) activeTables++;
    });
    
    // Master info
    const masterId = roomData.master_id || 'unknown';
    const ageSeconds = Math.floor(masterAge / 1000);
    const ageStr = ageSeconds < 60 
      ? `${ageSeconds}s ago` 
      : `${Math.floor(ageSeconds / 60)}m ago`;
    
    // Sort tables by ID
    const sortedTables = tables.sort((a, b) => a.id - b.id);
    
    html += `
    <div class="room-section ${masterOnline ? '' : 'offline'}">
      <div class="room-header">
        <div class="room-header-left">
          <div class="room-title">${roomName}</div>
          <div class="master-status ${masterOnline ? 'online' : 'offline'}">
            ${masterOnline ? '‚óè ONLINE' : '‚óã OFFLINE'}
          </div>
        </div>
        <div class="room-info">
          <div class="room-info-item">
            <span class="room-info-label">Master:</span>
            <span class="room-info-value">${masterId}</span>
          </div>
          <div class="room-info-item">
            <span class="room-info-label">Tables:</span>
            <span class="room-info-value">${tables.length}</span>
          </div>
          <div class="room-info-item">
            <span class="room-info-label">Updated:</span>
            <span class="room-info-value">${ageStr}</span>
          </div>
        </div>
      </div>`;
    
    if (tables.length === 0) {
      html += `<div class="empty-room">No tables detected</div>`;
    } else {
      html += '<div class="table-grid">';
      
      sortedTables.forEach(table => {
        const status = getStatus(table.last_seen);
        const movingClass = table.moving ? 'moving' : '';
        const confidencePercent = Math.round(table.confidence * 100);
        
        html += `
        <div class="table-item ${status} ${movingClass}">
          <div class="table-confidence">${confidencePercent}%</div>
          <div class="table-id">${table.id}</div>
          <div class="table-rssi">${table.rssi} dBm</div>
          <div class="table-status">${status}</div>
        </div>`;
      });
      
      html += '</div>';
    }
    
    html += '</div>';
  }
  
  if (html === '') {
    showEmpty();
  } else {
    document.getElementById('content').innerHTML = html;
  }
  
  // Update stats
  document.getElementById('stat-rooms').textContent = totalRooms;
  document.getElementById('stat-tables').textContent = totalTables;
  document.getElementById('stat-active').textContent = activeTables;
  document.getElementById('stat-masters').textContent = activeMasters;
}

function showEmpty() {
  document.getElementById('content').innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">‚Äî</div>
      <div class="empty-text">NO ACTIVE MASTERS</div>
    </div>`;
  
  document.getElementById('stat-rooms').textContent = 0;
  document.getElementById('stat-tables').textContent = 0;
  document.getElementById('stat-active').textContent = 0;
  document.getElementById('stat-masters').textContent = 0;
}

function getStatus(lastSeen) {
  if (lastSeen < 30000) return 'active';
  if (lastSeen < 900000) return 'warning';
  return 'inactive';
}

// Debug —Ñ—É–Ω–∫—Ü—ñ—è
window.debugTables = () => {
  console.log('üìä Table Locations:', tableLocations);
  console.log('üìú Table History:', tableHistory);
  console.log('üïê Master Update Times:', masterUpdateTimes);
};
</script>

</body>
</html>
